/**
 *
 * Carlos III University of Madrid.
 *
 * Master Final Thesis: Heartbeat classifier based on ANN (Artificial Neural
 * Network).
 *
 * Author: Pedro Marcos Solórzano
 * Tutor: Luis Mengibar Pozo (Tutor)
 *
 *
 * Main source file
 *
 *
 */

#include "main.hpp"

int main(void)
{
  /*
   * Local declarations.
   */
  XGpio gpio;
  FRESULT fStatus;
  FATFS fileSystem;
  FIL fWeight, fTrain, fTest, fInput;
  int status, mode, newANN = 1;

  /*
   * LED's GPIO Initialization
   */
  status = XGpio_Initialize(&gpio, GPIO_DEVICE_ID);
  if (status != XST_SUCCESS) {
      cerr << "ERROR: GPIO failure." << endl;
      return XST_FAILURE;
  }
  XGpio_SetDataDirection(&gpio, LED_CHANNEL, LED_DIRECTION_MASK);
  XGpio_DiscreteWrite(&gpio, LED_CHANNEL, LED_READY_STATE);

  /*
   * Get working mode
   */
  mode = XGpio_DiscreteRead(&gpio, SW_CHANNEL)%2;

  /*
   * Introduction
   */
  cout << endl<<"ARTIFITIAL NEURONAL NETWORK"<<endl;
  cout <<
      mode = 1 ? "Back-propagation training for feedforward ANN" : "Feedforward ANN" << endl;

  /*
   * Initialize the memory file system
   */
  fStatus = f_mount(&fileSystem, FS_PATH, 0);
  if (fStatus != FR_OK) {
      cerr<<"ERROR: impossible to mount SD memory on "<<FS_PATH<<endl;
      XGpio_DiscreteWrite(&gpio,LED_CHANNEL,LED_ERROR_STATE);
      return XST_FAILURE;
  }

  /*
   * Open files
   */
  if (mode==1){
      fStatus = f_open(&fTrain, TRAINING_FILE_DIR , FA_READ);
      if (fStatus) {
	  cerr << "ERROR: Training file not found in " << FS_PATH <<
	      TRAINING_FILE_DIR << endl;
	  XGpio_DiscreteWrite(&gpio, LED_CHANNEL, LED_FILE_ERROR_STATE);
	  return XST_FAILURE;
      }
      fStatus = f_open(&fTest, TEST_FILE_DIR , FA_READ);
      if (fStatus) {
	  cerr << "ERROR: Test file not found in " << FS_PATH <<
	      TEST_FILE_DIR << endl;
	  XGpio_DiscreteWrite(&gpio, LED_CHANNEL, LED_FILE_ERROR_STATE);
	  return XST_FAILURE;
      }
      fStatus = f_open(&fWeight, WEIGHTS_FILE_DIR , FA_WRITE | FA_READ);
      if (!fStatus) {
	  newANN=0;
	  fStatus = f_open(&fWeight, WEIGHTS_FILE_DIR,
	                   FA_OPEN_ALWAYS | FA_WRITE | FA_READ);
	  if (fStatus) {
	      cerr << "ERROR: Impossible to create Weight file in " <<
		  FS_PATH << TEST_FILE_DIR << endl;
	      XGpio_DiscreteWrite(&gpio, LED_CHANNEL, LED_FILE_ERROR_STATE);
	      return XST_FAILURE;
	  }
      }
  }
  else{
      fStatus = f_open(&fWeight, WEIGHTS_FILE_DIR , FA_READ);
      if (fStatus) {
	  cerr << "ERROR: Weights file not found in " << FS_PATH <<
	      WEIGHTS_FILE_DIR << endl;
	  XGpio_DiscreteWrite(&gpio, LED_CHANNEL ,LED_FILE_ERROR_STATE);
	  return XST_FAILURE;
      }
  }
  /*
   * Read files
   */
  if(mode==1){
      fStatus = f_read(&file, (void*)fBuffer, fSize, &fBytesRead);
      if (fStatus || fSize!=fBytesRead) {
	  xil_printf(
	      "ERROR: Failed reading file %s%s. %i Bytes have been read.\r\n",
	      FS_PATH,
	      INPUT_DIR,
	      fBytesRead);
	  XGpio_DiscreteWrite(&led,LED_CHANNEL,LED_FILE_ERROR_STATE);
	  return XST_FAILURE;
      }
      fStatus = f_read(&file, (void*)fBuffer, fSize, &fBytesRead);
      if (fStatus || fSize!=fBytesRead) {
	  xil_printf(
	      "ERROR: Failed reading file %s%s. %i Bytes have been read.\r\n",
	      FS_PATH,
	      INPUT_DIR,
	      fBytesRead);
	  XGpio_DiscreteWrite(&led,LED_CHANNEL,LED_FILE_ERROR_STATE);
	  return XST_FAILURE;
      }

  }


  /*
   * Open weights file
   */

  return 0;
}
